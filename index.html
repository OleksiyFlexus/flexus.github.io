<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Бот для вивчення плитки - Тести</title>
    <!-- Telegram WebApp API -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0;
            padding: 20px;
            padding-bottom: env(safe-area-inset-bottom);
            box-sizing: border-box;
            min-height: 100vh;
            overflow-y: auto;
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
        }
        #app {
            min-height: 100vh;
        }
        .question { margin-bottom: 20px; }
        button { 
            margin-top: 10px; 
            padding: 10px; 
            background-color: var(--tg-theme-button-color, #007bff); 
            color: var(--tg-theme-button-text-color, white); 
            border: none; 
            cursor: pointer; 
            border-radius: 6px;
        }
        button:hover { opacity: 0.9; }
        .result { font-weight: bold; margin-top: 20px; }
    </style>
</head>
<body>
    <div id="app">
        <h1>Тест з вивчення плитки</h1>
        <p v-if="!quizCompleted">Поточне питання: {{ currentQuestion + 1 }} / {{ questions.length }}</p>
        
        <div v-if="!quizCompleted && questions.length > 0">
            <div class="question" v-for="(question, index) in questions" :key="index" v-if="currentQuestion === index">
                <p>{{ question.text }}</p>
                <div v-for="(option, optIndex) in question.options" :key="optIndex">
                    <label>
                        <input type="radio" v-model="userAnswers[index]" :value="optIndex">
                        {{ option }}
                    </label>
                </div>
            </div>
            <button v-if="currentQuestion < questions.length - 1" @click="nextQuestion">Наступне питання</button>
            <button v-else @click="submitQuiz">Завершити тест</button>
        </div>

        <div v-else-if="quizCompleted" class="result">
            <p>Ваш результат: {{ score }} / {{ questions.length }}</p>
            <button @click="restartQuiz">Почати заново</button>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    questions: [],
                    currentQuestion: 0,
                    userAnswers: [],
                    quizCompleted: false,
                    score: 0
                };
            },
            methods: {
                nextQuestion() {
                    if (this.userAnswers[this.currentQuestion] !== undefined) {
                        this.currentQuestion++;
                    } else {
                        alert('Оберіть відповідь!');
                    }
                },
                submitQuiz() {
                    if (this.userAnswers[this.currentQuestion] !== undefined) {
                        this.calculateScore();
                        this.quizCompleted = true;
                    } else {
                        alert('Оберіть відповідь!');
                    }
                },
                calculateScore() {
                    this.score = this.questions.reduce((acc, question, index) => {
                        return acc + (this.userAnswers[index] === question.correct ? 1 : 0);
                    }, 0);
                },
                restartQuiz() {
                    this.currentQuestion = 0;
                    this.userAnswers = [];
                    this.quizCompleted = false;
                    this.score = 0;
                },
                loadQuestionsFromTelegram() {
                    if (window.Telegram && window.Telegram.WebApp) {
                        Telegram.WebApp.ready();
                        Telegram.WebApp.expand();
                        
                        const data = Telegram.WebApp.initDataUnsafe || {};
                        console.log("Дані від Telegram:", data);

                        let questionsFromBot = [];

                        if (data?.questions) {
                            try {
                                // Якщо приходить як JSON-рядок — парсимо
                                questionsFromBot = typeof data.questions === "string" 
                                    ? JSON.parse(data.questions) 
                                    : data.questions;
                            } catch (e) {
                                console.error("Помилка парсингу questions:", e);
                            }
                        }

                        if (Array.isArray(questionsFromBot) && questionsFromBot.length > 0) {
                            this.questions = questionsFromBot;
                        } else {
                            // fallback — якщо бот не передав питання або формат неправильний
                            this.questions = [
                                {
                                    text: 'Що таке керамічна плитка?',
                                    options: ['Матеріал для покриття підлоги та стін', 'Вид металу', 'Тип тканини', 'Електронний пристрій'],
                                    correct: 0
                                },
                                {
                                    text: 'Які основні типи плитки?',
                                    options: ['Керамічна, порцелянова, скляна', 'Дерев\'яна, металева, пластикова', 'Паперова, тканинна, гумова', 'Електронна, механічна, оптична'],
                                    correct: 0
                                }
                            ];
                        }
                    } else {
                        alert("Telegram WebApp API недоступний");
                    }
                }
            },
            mounted() {
                this.loadQuestionsFromTelegram();
            }
        }).mount('#app');
    </script>
</body>
</html>
